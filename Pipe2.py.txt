import sys, os 
import argparse
import difflib
import gzip
import urllib.request

# function to parse command line arguments
def check_arg(args=None):
    parser = argparse.ArgumentParser(
    description="SPrediXcan Cell Data Processing Script.")
    parser.add_argument("-i", "--input",
    help="input file",
    required=True)
    parser.add_argument("-o", "--output",
    help="output file",
    required=True)
    return parser.parse_args(args)

# retrieve command line arguments
arguments = check_arg(sys.argv[1:])
infile = arguments.input
outfile = arguments.output

# link for the basic gene annotation GTF file
gtf_url = "https://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human/release_47/gencode.v47.basic.annotation.gtf.gz"

output_path = "./gencode_bga.gtf.gz"

# check if the file exists
if not os.path.exists(output_path):
    print(f"File not found locally. Downloading from {gtf_url}...")
    try:
        # download the file
        urllib.request.urlretrieve(gtf_url, output_path)
        print(f"Download complete: {output_path}")
    except Exception as e:
        print(f"An error occurred while downloading the file: {e}")
else:
    print(f"File already exists: {output_path}")

# Open and read the content of a .gz file
with gzip.open(infile, 'rt') as file:
    head = file.readline()
    header = " ".join(head.split())
    headers_list = header.split(" ")


# known column names
known_columns = ["snp_column", "effect_allele_column", "non_effect_allele_column", "beta_column", "pvalue_column", "se_column", "freq_column", "position_column", "chromosome_column", "gwas_h2", "gwas_N", "No match found" ] #deleted locus column

# GWAS headers to match
gwas_headers = headers_list 

explicit_mappings = {
    "P": "pvalue_column",
    "#CHROM": "chromosome_column",
    "CHR": "chromosome_column",
    "FREQ": "freq_column",
    "AF_Allele2": "freq_column",
    'BETA': 'beta_column', 
    'A1':'effect_allele_column',
    'A2': 'non_effect_allele_column',
    'REF': 'non_effect_allele_column', #changed from reference allele
    'ALT': 'effect_allele_column', #changed from other allele
    'SE': 'se_column',
    'Pvalue': 'pvalue_column',
    'BP': 'position_column',
    'POS': 'position_column',
    'SNP': 'snp_column',
    'SNP_hg38': 'snp_column',
    'ID': 'snp_column',
    'how': "No match found",
    'h2': 'gwas_h2',
    'heritability': 'gwas_h2',
    'sample_size': 'gwas_N',
    'N': 'gwas_N',
    'alleles': "No match found" #metaxcan doesn't recognize 'alleles column'
    }

# mapping headers to closest known column names
mapped_columns = {}
for header in gwas_headers:
    if header in explicit_mappings:
        mapped_columns[header] = explicit_mappings[header]
    else:
        matches = difflib.get_close_matches(header.lower(), [col.lower() for col in known_columns], n=1, cutoff=0.2)
        if matches:
            mapped_columns[header] = matches[0]
        else:
            mapped_columns[header] = "No match found"

# print the mapping
print(mapped_columns)

default_h2 = 0.4
default_N = 10000

# make the column info portion of the command using mapping from above, not including any "no match found" values
info_c = ""
for known_column in known_columns:
    matching_header = [key for key, value in mapped_columns.items() if value == known_column and value != "No match found"]
    if matching_header:
        info_c += f"--{known_column} \\{matching_header[0]} \\\n" #added \\ so it takes # as a str not a command
#if h2 and n are not present in the gwas headers, they will be replaced with default values
# if 'gwas_h2' not in mapped_columns.values():
#     print("No heritability column found, using default h2.")
#     info_c += f"--gwas_h2 {default_h2} \\\n"
# if 'gwas_N' not in mapped_columns.values():
#     print("No sample size column found, using default N.")
#     info_c += f"--gwas_N {default_N} \\\n"

# runs os.sys command and prints for debugging purposes
def run_bash(command): 
    print(f"Running command: {command}")
    os.system(command)

#get path from infile
gwas_path = os.path.dirname(os.path.abspath(infile)) 

#full list of cell data files
file_list = [
    "CD14-low_CD16-positive_monocyte_covariances.txt.gz",
    "CD14-low_CD16-positive_monocyte.db",
    "CD14-positive_monocyte_covariances.txt.gz",
    "CD14-positive_monocyte.db",
    "CD16-negative_CD56-bright_natural_killer_cell_human_covariances.txt.gz",
    "CD16-negative_CD56-bright_natural_killer_cell_human.db",
    "CD4-positive_alpha-beta_cytotoxic_T_cell_covariances.txt.gz",
    "CD4-positive_alpha-beta_cytotoxic_T_cell.db",
    "CD4-positive_alpha-beta_T_cell_covariances.txt.gz",
    "CD4-positive_alpha-beta_T_cell.db",
    "CD8-positive_alpha-beta_T_cell_covariances.txt.gz",
    "CD8-positive_alpha-beta_T_cell.db",
    "central_memory_CD4-positive_alpha-beta_T_cell_covariances.txt.gz",
    "central_memory_CD4-positive_alpha-beta_T_cell.db",
    "central_memory_CD8-positive_alpha-beta_T_cell_covariances.txt.gz",
    "central_memory_CD8-positive_alpha-beta_T_cell.db",
    "conventional_dendritic_cell_covariances.txt.gz",
    "conventional_dendritic_cell.db",
    "dendritic_cell_covariances.txt.gz",
    "dendritic_cell.db",
    "double_negative_thymocyte_covariances.txt.gz",
    "double_negative_thymocyte.db",
    "effector_memory_CD4-positive_alpha-beta_T_cell_covariances.txt.gz",
    "effector_memory_CD4-positive_alpha-beta_T_cell.db",
    "effector_memory_CD8-positive_alpha-beta_T_cell_covariances.txt.gz",
    "effector_memory_CD8-positive_alpha-beta_T_cell.db",
    "erythrocyte_covariances.txt.gz",
    "erythrocyte.db",
    "gamma-delta_T_cell_covariances.txt.gz",
    "gamma-delta_T_cell.db",
    "hematopoietic_precursor_cell_covariances.txt.gz",
    "hematopoietic_precursor_cell.db",
    "innate_lymphoid_cell_covariances.txt.gz",
    "innate_lymphoid_cell.db",
    "memory_B_cell_covariances.txt.gz",
    "memory_B_cell.db",
    "mucosal_invariant_T_cell_covariances.txt.gz",
    "mucosal_invariant_T_cell.db",
    "naive_B_cell_covariances.txt.gz",
    "naive_B_cell.db",
    "naive_thymus-derived_CD4-positive_alpha-beta_T_cell_covariances.txt.gz",
    "naive_thymus-derived_CD4-positive_alpha-beta_T_cell.db",
    "naive_thymus-derived_CD8-positive_alpha-beta_T_cell_covariances.txt.gz",
    "naive_thymus-derived_CD8-positive_alpha-beta_T_cell.db",
    "natural_killer_cell_covariances.txt.gz",
    "natural_killer_cell.db",
    "peripheral_blood_mononuclear_cell_covariances.txt.gz",
    "peripheral_blood_mononuclear_cell.db",
    "plasmablast_covariances.txt.gz",
    "plasmablast.db",
    "plasmacytoid_dendritic_cell_covariances.txt.gz",
    "plasmacytoid_dendritic_cell.db",
    "platelet_covariances.txt.gz",
    "platelet.db",
    "regulatory_T_cell_covariances.txt.gz",
    "regulatory_T_cell.db",
    "transitional_stage_B_cell_covariances.txt.gz",
    "transitional_stage_B_cell.db"
]

#seperates files based on type indicators
covariance_files = [f for f in file_list if f.endswith("_covariances.txt.gz")]
db_files = [f for f in file_list if f.endswith(".db")]

cell_type_tracker = [] #tracks all cell types used
base_path = os.path.abspath('./CellData') #finds the base path for CellData in the users system, used to give metaxcan the full path

os.chdir('./MetaXcan/software/') # change directory so metaxcan can be called 

# loop through each covariance file and database file
for cov_file in covariance_files:
    # extract the cell type from covariance file name
    cell_type = cov_file.replace("_covariances.txt.gz", "")
    cell_type_tracker.append(cell_type) #for future use calling Manhattenplot.py
    # find corresponding database file, this way nothing needs to be in order = less user error
    db_file = next((db for db in db_files if db.startswith(cell_type)), None)
    if db_file:
        # output file name based on cell type
        output_file = f"--output_file {cell_type}_output.csv"
        main_command = (
            f"python SPrediXcan.py \\\n"
            f"--model_db_path {base_path}/{db_file} \\\n"
            f"--covariance {base_path}/{cov_file} \\\n"
            f"--gwas_folder {gwas_path} \\\n"
            f"--gwas_file_pattern \".*gz\" \\\n"
            "--chromosome all \\\n"
        )
        command = main_command + info_c + output_file #construct full command
        #run the command
        run_bash(command)
    else:
        print(f"No matching database file found for {cell_type}.") #debugging
